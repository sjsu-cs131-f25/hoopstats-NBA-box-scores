#!/usr/bin/env bash
# Usage: ./run_pa4.sh data/{csv}

set -euo pipefall
IFS=$'\n\t'

die() { echo "ERROR: $*" >&2; exit 1; }
log() { printf '[%s] %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$*" >&2; }

TEAM_NAME=$1
DATASET_PATH=${2:-}
cd /mnt/scratch/CS131_jelenag/projects/${TEAM_NAME}/ || die "Cannot cd to dir"
OUT_DIR="out"
LOG_DIR="log"
mkdir -p "$OUT_DIR"/{samples, tables, clean} "$LOG_DIR"

[ -z "$TEAM_NAME" ] && die "Usage: $0 <team-name> <input-dir>"
[ -z "$DATASET_PATH" ] && die "Usage: $0 <input-dir>"
[ ! -f "$DATASET_PATH" ] && die "Input file not found: $DATASET_PATH"

chmod -R g+rX "$(dirname "$DATASET_PATH")" || log "warn: could not chmod inputs"

if [ -d "$DATASET_PATH" ]; then
  log "Processing all CSVs in dir: $DATASET_PATH"
  for csv in "$DATASET_PATH"/*.csv; do
    [ -e "$csv" ] || { log "No CSV files found in $DATASET_PATH"; exit 1; }
    bash "$0" "$TEAM_NAME" "$csv"
  done
  exit 0
fi
BASENAME=$(basename "$DATASET_PATH")
NAME=${BASENAME%.*}
CLEAN="$OUT_DIR/clean/${NAME}.tsv

log "Cleaning & normalizing $INPUT -> $CLEAN"

sed -E '
  s /\r//g;
  s/^[[:space:]]+//; s/[[:space:]]+$//;
  s/[[:space:]]{2,}/ /g;
  s/"|"/"/g; s/'|'/'\''/g;
  s/\[|\]|\(|\)//g;
  :a; s/([0-9]),([0-9]{3})/\1\2/g; ta;
  s/,/\t/g;
  s/\t+/\t/g;
  s/(^|[\t])([Nn][Aa]|NULL)([\t]|$)/\1\3/g'
  "$DATASET_PATH" > "$CLEAN"

head -n 10 "$DATASET_FILE" > "$OUT_DIR/samples/sample_before_${NAME}.txt"
head -n 10 "$CLEAN" > "$OUT_DIR/samples/sample_after_${NAME}.tsv"

log "Saved before/after samples in $OUT_DIR/samples/"


{tail -n +2 "$CLEAN" | cut -f4
 tail -n +2 "$CLEAN" | cut -f6 }
 | sort | awk 'NF==0{$0="<EMPTY>"}{print}' |  uniq -c | sort -nr |\
awk '{print $2 "\t" $1}' | sed '1iTeam\tCount' > out/freq_team.tsv
log "Made frequency table number 1"

tail -n +2 "$CLEAN" | cut -f7 | sort | uniq -c | sort -nr |\
awk '{print $2 "\t" $1}' | sed '1iHeight\tCount' > out/freq_team.tsv
log "Made frequency table number 2"

tail -n +2 "$CLEAN" | cut -f5 | sort | uniq -c | sort -nr | head -n 20 |\
awk '{print NR "\t" $2 "\t" $1}' | sed '1iRank\tLast Attended\tCount' > out/top20_players.tsv
log "Made top-N list"

cut -f7,9,21,22,23 "$CLEAN" | sort -u > out/skinny_table.tsv
log "Made skinny table"
